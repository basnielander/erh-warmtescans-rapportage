<div class="report-container">
  <div class="report-header">
    <button (click)="goBack()" class="btn-back">â† Folders</button>
    <h2>ğŸ“Š {{ folderName() }} - {{ photosTakenAt() }}</h2>
  </div>

  <!-- Menu Bar -->
  <div class="menu-bar" *ngIf="!isSettingUp() && !isLoadingReport() && addressReport()">
    <div class="menu-section">
      <h4 class="menu-section-title">ğŸ”§ Tools</h4>
      <div class="menu-buttons">
        <button 
          class="menu-btn menu-btn-outdoor" 
          (click)="onShowBatchOutdoorCalibration()" 
          *ngIf="outdoorImagesAvailable()"
          [disabled]="isUpdatingIndices()">
          ğŸŒ¤ï¸ Calibrate Outdoor Images
        </button>
        <button 
          class="menu-btn menu-btn-indoor" 
          (click)="onShowBatchIndoorCalibration()" 
          *ngIf="indoorImagesAvailable()"
          [disabled]="isUpdatingIndices()">
          ğŸ  Calibrate Indoor Images
        </button>
        <button 
          class="menu-btn menu-btn-export" 
          (click)="onExportReport()"
          [disabled]="isUpdatingIndices() || isExportingReport()">
          {{ isExportingReport() ? 'â³ Exporting...' : 'ğŸ“¥ Export Report' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Setup Status -->
  <div *ngIf="isSettingUp()" class="setup-status loading">
    <div class="spinner"></div>
    <p>Setting up address folder...</p>
  </div>

  <div *ngIf="setupError()" class="setup-status error">
    <p>âš ï¸ {{ setupError() }}</p>
    <button (click)="setupAddressFolder()" class="btn-retry">Retry Setup</button>
  </div>

  <!-- Report Loading Status -->
  <div *ngIf="isLoadingReport()" class="setup-status loading">
    <div class="spinner"></div>
    <p>Loading report...</p>
  </div>

  <div *ngIf="reportError()" class="setup-status error">
    <p>âš ï¸ {{ reportError() }}</p>
    <button (click)="loadReport()" class="btn-retry">Retry Loading Report</button>
  </div>

  <div class="report-content" *ngIf="!isSettingUp() && !isLoadingReport()">
    <!-- Report Details & Map Side by Side -->
    <div class="details-map-section" *ngIf="addressReport()">
      <div class="report-details-wrapper">
        <app-report-details-editor
          [report]="addressReport()!"
          (save)="onReportDetailsSave($event)"
          (cancel)="onReportDetailsCancel()">
        </app-report-details-editor>
      </div>
      
      <div class="map-section">
        <app-map-display [address]="folderName()"></app-map-display>
      </div>
    </div>

    <!-- Images Section -->
    <div class="images-section" *ngIf="addressReport() && allIncludedImages().length > 0">
      <h3>ğŸ–¼ï¸ Images in "2. Bewerkt" Folder</h3>
      <div class="update-status" *ngIf="isUpdatingIndices()">
        <div class="spinner-small"></div>
        <span>Volgorde van scans voor het rapport update...</span>
      </div>
      <div class="images-grid">
        <div 
          *ngFor="let image of allIncludedImages(); let i = index"
          class="image-wrapper"
          [class.dragging]="draggedIndex() === i"
          draggable="true"
          (dragstart)="onDragStart($event, i)"
          (dragover)="onDragOver($event)"
          (drop)="onDrop($event, i)"
          (dragend)="onDragEnd()">
          <div class="drag-handle">â‹®â‹®</div>
          <app-image-card 
            [image]="image"
            (toggleExclude)="onToggleExcludeImage($event)"
            (updateImageProperties)="onUpdateImageProperties($event)">
          </app-image-card>
        </div>
      </div>
    </div>

    <!-- Excluded Images Section -->
    <div class="images-section excluded-section" *ngIf="addressReport() && excludedImages().length > 0">
      <h3>ğŸ—‘ï¸ Excluded Images</h3>
      <p class="section-description">These images have been excluded from the report.</p>
      <div class="images-grid">
        <div 
          *ngFor="let image of excludedImages(); let i = index"
          class="image-wrapper excluded">
          <app-image-card 
            [image]="image"
            (toggleExclude)="onToggleExcludeImage($event)"
            (updateImageProperties)="onUpdateImageProperties($event)">
          </app-image-card>
        </div>
      </div>
    </div>

    <!-- No Images Message -->
    <div class="no-images" *ngIf="addressReport() && sortedImages().length === 0">
      <p>ğŸ“­ No images found in the "2. Bewerkt" folder.</p>
    </div>
  </div>

  <!-- Batch Outdoor Calibration Modal -->
  <app-modal 
    [isOpen]="showBatchOutdoorCalibration()" 
    title="ğŸŒ¤ï¸ Batch Calibrate Outdoor Images"
    (close)="onBatchCalibrationCancel()">
    <app-batch-outdoor-calibration
      *ngIf="showBatchOutdoorCalibration()"
      [images]="allIncludedImages()"
      (saveCalibration)="onBatchCalibrationSave($event)"
      (cancel)="onBatchCalibrationCancel()">
    </app-batch-outdoor-calibration>
  </app-modal>

  <!-- Batch Indoor Calibration Modal -->
  <app-modal 
    [isOpen]="showBatchIndoorCalibration()" 
    title="ğŸ  Batch Calibrate Indoor Images"
    (close)="onBatchCalibrationCancel()">
    <app-batch-indoor-calibration
      *ngIf="showBatchIndoorCalibration()"
      [images]="allIncludedImages()"
      (saveCalibration)="onBatchCalibrationSave($event)"
      (cancel)="onBatchCalibrationCancel()">
    </app-batch-indoor-calibration>
  </app-modal>
</div>
